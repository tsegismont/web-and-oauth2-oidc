<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <title>Securing a Web Application with OAuth2/OpenId Connect | Eclipse Vert.x how-to</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.7.1/css/all.css" integrity="sha384-fnmOCqbTlWIlj8LyTjo7mOUStjsKC4pOpQbqyi7RrhN7udi9RwhKkMHpvLbHG9Sr"
    crossorigin="anonymous">
  <link rel="icon" type="image/svg+xml" href="assets/images/vertx-square.svg">
</head>

<body>


<nav class="navbar navbar-expand-lg sticky-top navbar-dark bg-purple mb-4 shadow-sm">
  <a class="navbar-brand" href="/">
    <img src="assets/images/vertx-square.svg" alt="Vert.x" width="40" height="40">
    &nbsp; Eclipse Vert.x how-to
  </a>
  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav"
    aria-expanded="false" aria-label="Toggle navigation">
    <span class="navbar-toggler-icon"></span>
  </button>
  <div class="collapse navbar-collapse" id="navbarNav">
    <ul class="navbar-nav">
      <li class="nav-item">
        <a class="nav-link" href="https://vertx.io/docs/"><i class="fas fa-lg fa-drafting-compass"></i> Vert.x docs</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com/"><i class="fab fa-lg fa-github"></i> Source
          code</a>
      </li>
      <li class="nav-item">
        <a class="nav-link" href="https://github.com//edit/master/README.adoc"><i
            class="far fa-lg fa-edit"></i>
          Edit this</a>
      </li>
    </ul>
  </div>
</nav>

<div class="container">

  <div class="row">
    <div class="col">
      <h1>Securing a Web Application with OAuth2/OpenId Connect</h1>
      <div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#what-you-will-build">What you will build</a></li>
<li><a href="#what-you-need">What you need</a></li>
<li><a href="#create-a-project">Create a Project</a></li>
<li><a href="#basics-of-authentication">Basics of Authentication</a></li>
<li><a href="#registering-your-app">Registering your app</a></li>
<li><a href="#accepting-user-authorization">Accepting user authorization</a></li>
<li><a href="#checking-granted-scopes">Checking granted scopes</a></li>
<li><a href="#making-authenticated-requests">Making authenticated requests</a></li>
<li><a href="#implementing-persistent-authentication">Implementing "persistent" authentication</a>
<ul class="sectlevel2">
<li><a href="#why-persistence-is-important">Why persistence is important?</a></li>
</ul>
</li>
<li><a href="#openid-connect">OpenID Connect</a></li>
<li><a href="#summary">Summary</a></li>
<li><a href="#see-also">See also</a></li>
</ul>
</div>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This how to will show you how to build and secure a simple web vert.x application with Oauth2 and OpenId Connect.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-will-build">What you will build</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the first part of the how-to, you will build a secure web application that will use GitHub to authenticate any application user. We will then continue exploring the API and use OpenId Connect to auto discover the security related configuration of the application.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="what-you-need">What you need</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>A text editor or IDE</p>
</li>
<li>
<p>Java 8 or higher (11 recommended for the extra security algorithms)</p>
</li>
<li>
<p>GitHub account</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="create-a-project">Create a Project</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Go to start.vertx.io and <a href="https://start.vertx.io/starter.zip?groupId=howto&amp;artifactId=oauth-oidc&amp;vertxDependencies=vertx-web&amp;vertx-auth-oauth2,vertx-web-templ-handlebars,vertx-web-client">create a project</a> with the following dependencies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Vert.x Web</p>
</li>
<li>
<p>Oauth2</p>
</li>
<li>
<p>Handlebars template engine</p>
</li>
<li>
<p>Vert.x Web Client</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="project.png" alt="project" width="600">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="basics-of-authentication">Basics of Authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we&#8217;re going to focus on the basics of authentication. Specifically, we&#8217;re going to create a Java server that implements GitHub&#8217;s <a href="https://docs.github.com/en/developers/apps/authorizing-oauth-apps">web application flow</a>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="registering-your-app">Registering your app</h2>
<div class="sectionbody">
<div class="paragraph">
<p>First, you&#8217;ll need to <a href="https://github.com/settings/applications/new">register your application</a>. Every registered OAuth2 application is assigned a unique <strong>Client ID</strong> and <strong>Client Secret</strong>. The Client Secret should <strong>NOT</strong> be shared! That includes checking the string into your repository.</p>
</div>
<div class="paragraph">
<p>You can fill out every piece of information however you like, except the <strong>Authorization callback URL</strong>. This is easily the most important piece to setting up your application. It&#8217;s the callback URL that GitHub returns the user to after successful authentication.</p>
</div>
<div class="paragraph">
<p>Since we&#8217;re running a regular Vert.x Web server, the location of the local instance is set to <code><a href="http://localhost:8080" class="bare">http://localhost:8080</a></code>. Let&#8217;s fill in the callback URL as <code><a href="http://localhost:8080/callback" class="bare">http://localhost:8080/callback</a></code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="accepting-user-authorization">Accepting user authorization</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now, let&#8217;s start filling out our simple server. Open the class <code>howto.oauth_oidc.MainVerticle</code> and paste this into it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">package</span> <span style="color: #555555">howto.oauth_oidc</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.core.AbstractVerticle</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.core.Promise</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.oauth2.OAuth2Auth</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.oauth2.providers.GithubAuth</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.Router</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.handler.OAuth2AuthHandler</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.templ.handlebars.HandlebarsTemplateEngine</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">MainVerticle</span> <span style="color: #000000;font-weight: bold">extends</span> <span style="color: #445588;font-weight: bold">AbstractVerticle</span> <span style="color: #000000;font-weight: bold">{</span>

  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">static</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">String</span> <span style="color: #008080">CLIENT_ID</span> <span style="color: #000000;font-weight: bold">=</span>
    <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getenv</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"GITHUB_CLIENT_ID"</span><span style="color: #000000;font-weight: bold">);</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">static</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">String</span> <span style="color: #008080">CLIENT_SECRET</span> <span style="color: #000000;font-weight: bold">=</span>
    <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getenv</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"GITHUB_CLIENT_SECRET"</span><span style="color: #000000;font-weight: bold">);</span>  // <b class="conum">(1)</b>

  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">start</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Promise</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">Void</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">startPromise</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>

    <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span> <span style="background-color: #f8f8f8">engine</span> <span style="color: #000000;font-weight: bold">=</span>
      <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">);</span>     // <b class="conum">(2)</b>

    <span style="color: #445588;font-weight: bold">Router</span> <span style="background-color: #f8f8f8">router</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #445588;font-weight: bold">Router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">router</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">);</span>         // <b class="conum">(3)</b>

    <span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">get</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"/"</span><span style="color: #000000;font-weight: bold">)</span>                               // <b class="conum">(4)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">handler</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #999988;font-style: italic">// we pass the client id to the template</span>
        <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">put</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"client_id"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">CLIENT_ID</span><span style="color: #000000;font-weight: bold">);</span>
        <span style="color: #999988;font-style: italic">// and now delegate to the engine to render it.</span>
        <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">render</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">data</span><span style="color: #000000;font-weight: bold">(),</span> <span style="color: #d14">"views/index.hbs"</span><span style="color: #000000;font-weight: bold">)</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
            <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">response</span><span style="color: #000000;font-weight: bold">()</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">putHeader</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"Content-Type"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #d14">"text/html"</span><span style="color: #000000;font-weight: bold">)</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">end</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span><span style="color: #000000;font-weight: bold">);</span>
          <span style="color: #000000;font-weight: bold">})</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #990000;font-weight: bold">ctx:</span><span style="color: #000000;font-weight: bold">:</span><span style="background-color: #f8f8f8">fail</span><span style="color: #000000;font-weight: bold">);</span>
      <span style="color: #000000;font-weight: bold">});</span>

    <span style="color: #445588;font-weight: bold">OAuth2Auth</span> <span style="background-color: #f8f8f8">authProvider</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #445588;font-weight: bold">GithubAuth</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">CLIENT_ID</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">CLIENT_SECRET</span><span style="color: #000000;font-weight: bold">);</span>

    <span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">get</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"/protected"</span><span style="color: #000000;font-weight: bold">)</span>                      // <b class="conum">(5)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">handler</span><span style="color: #000000;font-weight: bold">(</span>
        <span style="color: #445588;font-weight: bold">OAuth2AuthHandler</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">authProvider</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #d14">"http://localhost:8080/callback"</span><span style="color: #000000;font-weight: bold">)</span>   // <b class="conum">(6)</b>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setupCallback</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">route</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"/callback"</span><span style="color: #000000;font-weight: bold">))</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">withScope</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"user:email"</span><span style="color: #000000;font-weight: bold">))</span>               // <b class="conum">(7)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">handler</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">response</span><span style="color: #000000;font-weight: bold">()</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">end</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"Hello protected!"</span><span style="color: #000000;font-weight: bold">);</span>
      <span style="color: #000000;font-weight: bold">});</span>

    <span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">createHttpServer</span><span style="color: #000000;font-weight: bold">()</span>                      // <b class="conum">(8)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">requestHandler</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">listen</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Integer</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getInteger</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"port"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #009999">8080</span><span style="color: #000000;font-weight: bold">))</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">server</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">out</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">println</span><span style="color: #000000;font-weight: bold">(</span>
          <span style="color: #d14">"HTTP server started on port: "</span> <span style="color: #000000;font-weight: bold">+</span> <span style="background-color: #f8f8f8">server</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">actualPort</span><span style="color: #000000;font-weight: bold">());</span>
        <span style="background-color: #f8f8f8">startPromise</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">complete</span><span style="color: #000000;font-weight: bold">();</span>
      <span style="color: #000000;font-weight: bold">}).</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #990000;font-weight: bold">startPromise:</span><span style="color: #000000;font-weight: bold">:</span><span style="background-color: #f8f8f8">fail</span><span style="color: #000000;font-weight: bold">);</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>We will read the secrets as environment variables</p>
</li>
<li>
<p>In order to use a handlebars we first need to create an engine</p>
</li>
<li>
<p>To simplify the development of the web components we use a Router to route all HTTP requests to organize our code in a reusable way.</p>
</li>
<li>
<p>Entry point to the application, this will render a custom template.</p>
</li>
<li>
<p>The protected resource (not really protected yet)</p>
</li>
<li>
<p>We now configure the oauth2 handler, it will setup the callback handler (as defined in GitHub Application panel)</p>
</li>
<li>
<p>For this resource we require that users have the authority to retrieve the user emails</p>
</li>
<li>
<p>Start up the server</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Your client ID and client secret keys come from <a href="https://github.com/settings/developers">your application&#8217;s configuration page</a>. You should <strong>NEVER</strong>, <strong>EVER</strong> store these values in your git repository&#8201;&#8212;&#8201;or any other public place, for that matter. We recommend storing them as <a href="http://en.wikipedia.org/wiki/Environment_variable#Getting_and_setting_environment_variables">environment variables</a>&#8201;&#8212;&#8201;which is exactly what we&#8217;ve done here.</p>
</div>
<div class="paragraph">
<p>Notice that the protected resource uses the scope <code>user:email</code> to define the scopes requested by the application. For our application, we&#8217;re requesting <code>user:email</code> scope for reading private email addresses later in the how-to.</p>
</div>
<div class="paragraph">
<p>Next, in the project <code>resources</code> create the template <code>views/index.hbs</code> and paste this content:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="handlebars"><span style="color: #000080">&lt;html</span> <span style="color: #008080">lang=</span><span style="color: #d14">"en"</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;body&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>
  Well, hello there!
<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>
  We're going to the protected resource, if there is no
  user in the session we will talk to the GitHub API. Ready?
  <span style="color: #000080">&lt;a</span> <span style="color: #008080">href=</span><span style="color: #d14">"/protected"</span><span style="color: #000080">&gt;</span>Click here<span style="color: #000080">&lt;/a&gt;</span> to begin!
<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>
  <span style="color: #000080">&lt;b&gt;</span>If that link doesn't work<span style="color: #000080">&lt;/b&gt;</span>, remember to provide
  your own <span style="color: #000080">&lt;a</span> <span style="color: #008080">href=</span><span style="color: #d14">"https://github.com/settings/applications/new"</span><span style="color: #000080">&gt;</span>
  Client ID<span style="color: #000080">&lt;/a&gt;</span>!
<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>(If you&#8217;re unfamiliar with how <a href="http://handlebarsjs.com/">Handlebars</a> works, we recommend reading the <a href="http://handlebarsjs.com/">Handlebars</a> guide.)</p>
</div>
<div class="paragraph">
<p>Navigate your browser to <a href="http://localhost:8080" class="bare">http://localhost:8080</a>. After clicking on the link, you should be taken to GitHub, and presented with a dialog that looks something like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="authorize.png" alt="authorize" width="600">
</div>
</div>
<div class="paragraph">
<p>After a successful app authentication, GitHub provides a temporary code value. This code is then posted back to GitHub in exchange for an <code>access_token</code> which is in turn translated to a <code>User</code> instance in your vert.x application. All this is taken care for you by the handler.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="checking-granted-scopes">Checking granted scopes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before the <code>User</code> object is handled to you, if your handler was configured with <code>authorities</code> they will be first checked. If they are not present then the whole process is aborted with an <code>Authorization (403)</code> error.</p>
</div>
<div class="paragraph">
<p>However you might want to assert for other granted authorities, in this case you would add a intermediate handler such as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">AuthorizationHandler</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span>
  <span style="color: #445588;font-weight: bold">PermissionBasedAuthorization</span>      // <b class="conum">(1)</b>
    <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"user:email"</span><span style="color: #000000;font-weight: bold">))</span>          // <b class="conum">(2)</b>
    <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">addAuthorizationProvider</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">ScopeAuthorization</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">" "</span><span style="color: #000000;font-weight: bold">)))</span>  // <b class="conum">(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Create a kind of authorization, in this case it&#8217;s a Permission</p>
</li>
<li>
<p>The <code>permission</code> we want to assert</p>
</li>
<li>
<p>The <code>provider</code> object will extract the right data from the user and perform the assertion</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Case the assertion fails, the router will stop executing and return a <code>Forbidden</code> error.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="making-authenticated-requests">Making authenticated requests</h2>
<div class="sectionbody">
<div class="paragraph">
<p>At this moment your application is already secure, and you can execute handlers knowing that the users are real GitHub users. You can now execute API calls on behalf of the user. For example, we could update the protected resource to print out the user registered email addresses, and some basic profile information from the <code>userInfo</code> end point.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">package</span> <span style="color: #555555">howto.oauth_oidc</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.core.Handler</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.authentication.TokenCredentials</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.oauth2.OAuth2Auth</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.RoutingContext</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.client.WebClient</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.codec.BodyCodec</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.web.templ.handlebars.HandlebarsTemplateEngine</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">ProtectedProfileHandler</span> <span style="color: #000000;font-weight: bold">implements</span> <span style="color: #445588;font-weight: bold">Handler</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">RoutingContext</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="color: #000000;font-weight: bold">{</span>

  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">OAuth2Auth</span> <span style="background-color: #f8f8f8">authProvider</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span> <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">;</span>

  <span style="color: #445588;font-weight: bold">ProtectedProfileHandler</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">OAuth2Auth</span> <span style="background-color: #f8f8f8">authProvider</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span> <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #000000;font-weight: bold">this</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">authProvider</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">authProvider</span><span style="color: #000000;font-weight: bold">;</span>
    <span style="color: #000000;font-weight: bold">this</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">engine</span> <span style="color: #000000;font-weight: bold">=</span> <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">;</span>
  <span style="color: #000000;font-weight: bold">}</span>

  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">handle</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">RoutingContext</span> <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="background-color: #f8f8f8">authProvider</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">userInfo</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">user</span><span style="color: #000000;font-weight: bold">())</span>       // <b class="conum">(1)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">err</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">session</span><span style="color: #000000;font-weight: bold">().</span><span style="color: #008080">destroy</span><span style="color: #000000;font-weight: bold">();</span>
        <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">fail</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">err</span><span style="color: #000000;font-weight: bold">);</span>
      <span style="color: #000000;font-weight: bold">})</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">userInfo</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #999988;font-style: italic">// fetch the user emails from the github API</span>
        <span style="color: #445588;font-weight: bold">WebClient</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">vertx</span><span style="color: #000000;font-weight: bold">())</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getAbs</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"https://api.github.com/user/emails"</span><span style="color: #000000;font-weight: bold">)</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">authentication</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">TokenCredentials</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">user</span><span style="color: #000000;font-weight: bold">().&lt;</span><span style="color: #445588;font-weight: bold">String</span><span style="color: #000000;font-weight: bold">&gt;</span><span style="background-color: #f8f8f8">get</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"access_token"</span><span style="color: #000000;font-weight: bold">)))</span> // <b class="conum">(2)</b>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">as</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">BodyCodec</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">jsonArray</span><span style="color: #000000;font-weight: bold">())</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">send</span><span style="color: #000000;font-weight: bold">()</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">err</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
            <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">session</span><span style="color: #000000;font-weight: bold">().</span><span style="color: #008080">destroy</span><span style="color: #000000;font-weight: bold">();</span>
            <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">fail</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">err</span><span style="color: #000000;font-weight: bold">);</span>
          <span style="color: #000000;font-weight: bold">})</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">res</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
            <span style="background-color: #f8f8f8">userInfo</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">put</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"private_emails"</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">res</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">body</span><span style="color: #000000;font-weight: bold">());</span>
            <span style="color: #999988;font-style: italic">// we pass the client info to the template</span>
            <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">put</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"userInfo"</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">userInfo</span><span style="color: #000000;font-weight: bold">);</span>
            <span style="color: #999988;font-style: italic">// and now delegate to the engine to render it.</span>
            <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">render</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">data</span><span style="color: #000000;font-weight: bold">(),</span> <span style="color: #d14">"views/protected.hbs"</span><span style="color: #000000;font-weight: bold">)</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
                <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">response</span><span style="color: #000000;font-weight: bold">()</span>
                  <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">putHeader</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"Content-Type"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #d14">"text/html"</span><span style="color: #000000;font-weight: bold">)</span>
                  <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">end</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span><span style="color: #000000;font-weight: bold">);</span>
              <span style="color: #000000;font-weight: bold">})</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #990000;font-weight: bold">ctx:</span><span style="color: #000000;font-weight: bold">:</span><span style="background-color: #f8f8f8">fail</span><span style="color: #000000;font-weight: bold">);</span>
          <span style="color: #000000;font-weight: bold">});</span>
      <span style="color: #000000;font-weight: bold">});</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Get the user information from the OAuth2 userInfo endpoint</p>
</li>
<li>
<p>Make an API call on user behalf (using their access token)</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We can do whatever we want with our results. In this case, we&#8217;ll just dump them straight into protected.hbs:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="handlebars"><span style="color: #000080">&lt;html</span> <span style="color: #008080">lang=</span><span style="color: #d14">"en"</span><span style="color: #000080">&gt;</span>
<span style="color: #000080">&lt;body&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>Well, well, well, <span style="color: #000000;font-weight: bold">{{</span><span style="color: #008080">userInfo</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">login</span><span style="color: #000000;font-weight: bold">}}</span>!<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>
  <span style="color: #000000;font-weight: bold">{{#if</span> <span style="color: #008080">userInfo</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">email</span><span style="color: #000000;font-weight: bold">}}</span> It looks like your public email
    address is <span style="color: #000000;font-weight: bold">{{</span><span style="color: #008080">userInfo</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">email</span><span style="color: #000000;font-weight: bold">}}</span>.
  <span style="color: #000000;font-weight: bold">{{else}}</span> It looks like you don't have a public email.
    That's cool.
  <span style="color: #000000;font-weight: bold">{{/if}}</span>
<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;p&gt;</span>
  <span style="color: #000000;font-weight: bold">{{#if</span> <span style="color: #008080">userInfo</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">private_emails</span><span style="color: #000000;font-weight: bold">}}</span>
    With your permission, we were also able to dig up your
    private email addresses:
    <span style="color: #000000;font-weight: bold">{{#</span><span style="color: #555555">each</span> <span style="color: #008080">userInfo</span><span style="background-color: #f8f8f8">.</span><span style="color: #008080">private_emails</span><span style="color: #000000;font-weight: bold">}}</span>
      <span style="color: #000000;font-weight: bold">{{</span><span style="color: #008080">email</span><span style="color: #000000;font-weight: bold">}}{{#</span><span style="color: #555555">unless</span> <span style="color: #008080">@last</span><span style="color: #000000;font-weight: bold">}}</span>,<span style="color: #000000;font-weight: bold">{{/</span><span style="color: #555555">unless</span><span style="color: #000000;font-weight: bold">}}</span>
    <span style="color: #000000;font-weight: bold">{{/</span><span style="color: #555555">each</span><span style="color: #000000;font-weight: bold">}}</span>
  <span style="color: #000000;font-weight: bold">{{else}}</span>
    Also, you're a bit secretive about your private email
    addresses.
  <span style="color: #000000;font-weight: bold">{{/if}}</span>
<span style="color: #000080">&lt;/p&gt;</span>
<span style="color: #000080">&lt;/body&gt;</span>
<span style="color: #000080">&lt;/html&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>And you should get a simple screen like this:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="emails.png" alt="emails" width="600">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="implementing-persistent-authentication">Implementing "persistent" authentication</h2>
<div class="sectionbody">
<div class="paragraph">
<p>It&#8217;d be a pretty bad model if we required users to log into the app every single time they needed to access the web page. For example, try navigating directly to <a href="http://localhost:8080/protected" class="bare">http://localhost:8080/protected</a>. You&#8217;ll get an authentication request over and over.</p>
</div>
<div class="paragraph">
<p>What if we could circumvent the entire "click here" process, and just remember that, as long as the user&#8217;s logged into GitHub, they should be able to access this application? Hold on to your hat, because that&#8217;s <em>exactly what we&#8217;re going to do</em>.</p>
</div>
<div class="paragraph">
<p>Our little server above is rather simple. In order to wedge in some intelligent authentication, we&#8217;re going to switch over to using sessions for storing tokens. This will make authentication transparent to the user.</p>
</div>
<div class="paragraph">
<p>This can be achieved with the stock handlers, so our server file would be:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java">  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">start</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Promise</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">Void</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">startPromise</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>

    <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span> <span style="background-color: #f8f8f8">engine</span> <span style="color: #000000;font-weight: bold">=</span>
      <span style="color: #445588;font-weight: bold">HandlebarsTemplateEngine</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">);</span>

    <span style="color: #445588;font-weight: bold">Router</span> <span style="background-color: #f8f8f8">router</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #445588;font-weight: bold">Router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">router</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">);</span>

    <span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">route</span><span style="color: #000000;font-weight: bold">()</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">handler</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">SessionHandler</span>
        <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">LocalSessionStore</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">)));</span>  // <b class="conum">(1)</b>

    <span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">get</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"/"</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">handler</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #999988;font-style: italic">// we pass the client id to the template</span>
        <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">put</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"client_id"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #008080">CLIENT_ID</span><span style="color: #000000;font-weight: bold">);</span>
        <span style="color: #999988;font-style: italic">// and now delegate to the engine to render it.</span>
        <span style="background-color: #f8f8f8">engine</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">render</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">data</span><span style="color: #000000;font-weight: bold">(),</span> <span style="color: #d14">"views/index.hbs"</span><span style="color: #000000;font-weight: bold">)</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
            <span style="background-color: #f8f8f8">ctx</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">response</span><span style="color: #000000;font-weight: bold">()</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">putHeader</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"Content-Type"</span><span style="color: #000000;font-weight: bold">,</span> <span style="color: #d14">"text/html"</span><span style="color: #000000;font-weight: bold">)</span>
              <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">end</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">buffer</span><span style="color: #000000;font-weight: bold">);</span>
          <span style="color: #000000;font-weight: bold">})</span>
          <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #990000;font-weight: bold">ctx:</span><span style="color: #000000;font-weight: bold">:</span><span style="background-color: #f8f8f8">fail</span><span style="color: #000000;font-weight: bold">);</span>
      <span style="color: #000000;font-weight: bold">});</span>

    <span style="color: #999988;font-style: italic">// ...</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>A session handler using in memory storage will now be able to keep track of active users and you will not need to re-login on each request.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="why-persistence-is-important">Why persistence is important?</h3>
<div class="paragraph">
<p>While it may sound better to keep no state on the server, persistence has some benefits over stateless. When a session is available, your application will be safer. The reason is that Oauth2 uses <code>nonce/state</code> values during calls that can only be properly validated when a session is in place. With a session we ensure that <code>nonce</code> values are unique and not reusable so your application is protected against replay attacks.</p>
</div>
<div class="paragraph">
<p>A second layer of optional protection is the use of <a href="https://datatracker.ietf.org/doc/html/rfc7636">Proof Key for Code Exchange</a>. PKCE adds another layer of security to the exchanges between your application and the Oauth2 server to enable it you only need to configure your handler as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #445588;font-weight: bold">OAuth2AuthHandler</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">create</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">authProvider</span><span style="color: #000000;font-weight: bold">)</span>
  <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setupCallback</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">router</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">route</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"/callback"</span><span style="color: #000000;font-weight: bold">))</span>
  <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">withScope</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"user:email"</span><span style="color: #000000;font-weight: bold">)</span>
  <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">pkceVerifierLength</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #009999">64</span><span style="color: #000000;font-weight: bold">);</span>  // <b class="conum">(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>By specifying a length between 64 and 128 PKCE will be enabled</p>
</li>
</ol>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="openid-connect">OpenID Connect</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Until this moment, we have been covering, plain <code>OAuth2</code>. Vert.x also allows you to use <a href="https://openid.net/connect/">OpenID Connect</a>.</p>
</div>
<div class="paragraph">
<p>In a nutshell, OpenID Connect is a simple identity layer on top of the OAuth 2.0 protocol. The main differences are that tokens, are not opaque strings, but encoded in JSON Web Token format. This allows applications to have more fine-grained control on permissions/roles and reduce the number of round-trips to the IdP server. This also means that you will need to know much more information at front to start the application. For example, a few extra HTTP endpoints, security keys, etc&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p>Albeit this looking more complex, OpenID, defines a discovery API, which simplifies the setup to just a few lines of code. Instead of having you to know all the properties you can just (for example) discover the configuration if you&#8217;re using <a href="https://www.keycloak.org/">keycloak</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight" style="background-color: #f8f8f8"><code data-lang="java"><span style="color: #000000;font-weight: bold">package</span> <span style="color: #555555">howto.oauth_oidc</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.core.AbstractVerticle</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.core.Promise</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.oauth2.OAuth2Options</span><span style="color: #000000;font-weight: bold">;</span>
<span style="color: #000000;font-weight: bold">import</span> <span style="color: #555555">io.vertx.ext.auth.oauth2.providers.KeycloakAuth</span><span style="color: #000000;font-weight: bold">;</span>

<span style="color: #000000;font-weight: bold">public</span> <span style="color: #000000;font-weight: bold">class</span> <span style="color: #445588;font-weight: bold">KeycloakDiscoverVerticle</span> <span style="color: #000000;font-weight: bold">extends</span> <span style="color: #445588;font-weight: bold">AbstractVerticle</span> <span style="color: #000000;font-weight: bold">{</span>

  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">static</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">String</span> <span style="color: #008080">CLIENT_ID</span> <span style="color: #000000;font-weight: bold">=</span>
    <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getenv</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"KEYCLOAK_CLIENT_ID"</span><span style="color: #000000;font-weight: bold">);</span>
  <span style="color: #000000;font-weight: bold">private</span> <span style="color: #000000;font-weight: bold">static</span> <span style="color: #000000;font-weight: bold">final</span> <span style="color: #445588;font-weight: bold">String</span> <span style="color: #008080">CLIENT_SECRET</span> <span style="color: #000000;font-weight: bold">=</span>
    <span style="color: #445588;font-weight: bold">System</span><span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">getenv</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"KEYCLOAK_CLIENT_SECRET"</span><span style="color: #000000;font-weight: bold">);</span>

  <span style="color: #3c5d5d;font-weight: bold">@Override</span>
  <span style="color: #000000;font-weight: bold">public</span> <span style="color: #445588;font-weight: bold">void</span> <span style="color: #990000;font-weight: bold">start</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #445588;font-weight: bold">Promise</span><span style="color: #000000;font-weight: bold">&lt;</span><span style="color: #445588;font-weight: bold">Void</span><span style="color: #000000;font-weight: bold">&gt;</span> <span style="background-color: #f8f8f8">startPromise</span><span style="color: #000000;font-weight: bold">)</span> <span style="color: #000000;font-weight: bold">{</span>
    <span style="color: #445588;font-weight: bold">OAuth2Options</span> <span style="background-color: #f8f8f8">options</span> <span style="color: #000000;font-weight: bold">=</span> <span style="color: #000000;font-weight: bold">new</span> <span style="color: #445588;font-weight: bold">OAuth2Options</span><span style="color: #000000;font-weight: bold">()</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setClientID</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">CLIENT_ID</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setClientSecret</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #008080">CLIENT_SECRET</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setTenant</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"vertx-test"</span><span style="color: #000000;font-weight: bold">)</span>          // <b class="conum">(1)</b>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">setSite</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #d14">"https://your.keycloak.instance/auth/realms/{tenant}"</span><span style="color: #000000;font-weight: bold">);</span> // <b class="conum">(2)</b>

    <span style="color: #445588;font-weight: bold">KeycloakAuth</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">discover</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">vertx</span><span style="color: #000000;font-weight: bold">,</span> <span style="background-color: #f8f8f8">options</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onFailure</span><span style="color: #000000;font-weight: bold">(</span><span style="color: #990000;font-weight: bold">startPromise:</span><span style="color: #000000;font-weight: bold">:</span><span style="background-color: #f8f8f8">fail</span><span style="color: #000000;font-weight: bold">)</span>
      <span style="color: #000000;font-weight: bold">.</span><span style="color: #008080">onSuccess</span><span style="color: #000000;font-weight: bold">(</span><span style="background-color: #f8f8f8">authProvider</span> <span style="color: #000000;font-weight: bold">-&gt;</span> <span style="color: #000000;font-weight: bold">{</span>
        <span style="color: #999988;font-style: italic">// use the authProvider like before to</span>
        <span style="color: #999988;font-style: italic">// protect your application</span>
      <span style="color: #000000;font-weight: bold">});</span>
  <span style="color: #000000;font-weight: bold">}</span>
<span style="color: #000000;font-weight: bold">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<ol>
<li>
<p>Keycloak can host multiple applications so we can specify a tenant name</p>
</li>
<li>
<p>Keycloak server URL</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The discovery process will perform the configuration of all known HTTP endpoints, and load security keys used to validated tokens. Once ready  an instance of <code>OAuth2Auth</code> is returned like before. It is important here that you did not have to load and configure all this manually.</p>
</div>
<div class="paragraph">
<p><code>Discovery</code> is a standard so you can use it with other services (that support it), for example (in no particular order):</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Microsoft Azure</p>
</li>
<li>
<p>Google Cloud</p>
</li>
<li>
<p>Salesforce</p>
</li>
<li>
<p>Amazon Incognito</p>
</li>
<li>
<p>etc&#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="summary">Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this how-to we covered:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creating a web project</p>
</li>
<li>
<p>Secure a web application with Oauth2</p>
</li>
<li>
<p>Invoke secure APIs with WebClient and Oauth2</p>
</li>
<li>
<p>Persist user session data</p>
</li>
<li>
<p>Use OpenID Connect</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>I hope you now can use OAuth2 on your next project!</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="see-also">See also</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p><a href="https://vertx.io/docs/vertx-core/java/">The Vert.x core APIs documentation</a></p>
</li>
<li>
<p><a href="https://vertx.io/docs/vertx-web/java/">The Vert.x web documentation</a></p>
</li>
<li>
<p><a href="https://vertx.io/docs/vertx-auth-oauth2/java/">The Vert.x OAuth2 documentation</a></p>
</li>
<li>
<p><a href="https://vertx.io/docs/vertx-web-client/java/">The Vert.x web client documentation</a></p>
</li>
</ul>
</div>
</div>
</div>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <!-- Sharingbutton Facebook -->
<a class="resp-sharing-button__link" href="https://facebook.com/sharer/sharer.php?u=https://vertx-howtos.github.io/web-and-oauth2-oidc" target="_blank"
    rel="noopener" aria-label="">
    <div class="resp-sharing-button resp-sharing-button--facebook resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M18.77 7.46H14.5v-1.9c0-.9.6-1.1 1-1.1h3V.5h-4.33C10.24.5 9.5 3.44 9.5 5.32v2.15h-3v4h3v12h5v-12h3.85l.42-4z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton Twitter -->
<a class="resp-sharing-button__link" href="https://twitter.com/intent/tweet/?text=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect&amp;url=https://vertx-howtos.github.io/web-and-oauth2-oidc"
    target="_blank" rel="noopener" aria-label="">
    <div class="resp-sharing-button resp-sharing-button--twitter resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M23.44 4.83c-.8.37-1.5.38-2.22.02.93-.56.98-.96 1.32-2.02-.88.52-1.86.9-2.9 1.1-.82-.88-2-1.43-3.3-1.43-2.5 0-4.55 2.04-4.55 4.54 0 .36.03.7.1 1.04-3.77-.2-7.12-2-9.36-4.75-.4.67-.6 1.45-.6 2.3 0 1.56.8 2.95 2 3.77-.74-.03-1.44-.23-2.05-.57v.06c0 2.2 1.56 4.03 3.64 4.44-.67.2-1.37.2-2.06.08.58 1.8 2.26 3.12 4.25 3.16C5.78 18.1 3.37 18.74 1 18.46c2 1.3 4.4 2.04 6.97 2.04 8.35 0 12.92-6.92 12.92-12.93 0-.2 0-.4-.02-.6.9-.63 1.96-1.22 2.56-2.14z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton E-Mail -->
<a class="resp-sharing-button__link" href="mailto:?subject=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect&amp;body=https://vertx-howtos.github.io/web-and-oauth2-oidc" target="_self" rel="noopener"
    aria-label="">
    <div class="resp-sharing-button resp-sharing-button--email resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M22 4H2C.9 4 0 4.9 0 6v12c0 1.1.9 2 2 2h20c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zM7.25 14.43l-3.5 2c-.08.05-.17.07-.25.07-.17 0-.34-.1-.43-.25-.14-.24-.06-.55.18-.68l3.5-2c.24-.14.55-.06.68.18.14.24.06.55-.18.68zm4.75.07c-.1 0-.2-.03-.27-.08l-8.5-5.5c-.23-.15-.3-.46-.15-.7.15-.22.46-.3.7-.14L12 13.4l8.23-5.32c.23-.15.54-.08.7.15.14.23.07.54-.16.7l-8.5 5.5c-.08.04-.17.07-.27.07zm8.93 1.75c-.1.16-.26.25-.43.25-.08 0-.17-.02-.25-.07l-3.5-2c-.24-.13-.32-.44-.18-.68s.44-.32.68-.18l3.5 2c.24.13.32.44.18.68z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton LinkedIn -->
<a class="resp-sharing-button__link"
    href="https://www.linkedin.com/shareArticle?mini=true&amp;url=https://vertx-howtos.github.io/web-and-oauth2-oidc&amp;title=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect&amp;summary=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect&amp;source=https://vertx-howtos.github.io/web-and-oauth2-oidc"
    target="_blank" rel="noopener" aria-label="">
    <div class="resp-sharing-button resp-sharing-button--linkedin resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M6.5 21.5h-5v-13h5v13zM4 6.5C2.5 6.5 1.5 5.3 1.5 4s1-2.4 2.5-2.4c1.6 0 2.5 1 2.6 2.5 0 1.4-1 2.5-2.6 2.5zm11.5 6c-1 0-2 1-2 2v7h-5v-13h5V10s1.6-1.5 4-1.5c3 0 5 2.2 5 6.3v6.7h-5v-7c0-1-1-2-2-2z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton Reddit -->
<a class="resp-sharing-button__link"
    href="https://reddit.com/submit/?url=https://vertx-howtos.github.io/web-and-oauth2-oidc&amp;resubmit=true&amp;title=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect" target="_blank" rel="noopener"
    aria-label="">
    <div class="resp-sharing-button resp-sharing-button--reddit resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M24 11.5c0-1.65-1.35-3-3-3-.96 0-1.86.48-2.42 1.24-1.64-1-3.75-1.64-6.07-1.72.08-1.1.4-3.05 1.52-3.7.72-.4 1.73-.24 3 .5C17.2 6.3 18.46 7.5 20 7.5c1.65 0 3-1.35 3-3s-1.35-3-3-3c-1.38 0-2.54.94-2.88 2.22-1.43-.72-2.64-.8-3.6-.25-1.64.94-1.95 3.47-2 4.55-2.33.08-4.45.7-6.1 1.72C4.86 8.98 3.96 8.5 3 8.5c-1.65 0-3 1.35-3 3 0 1.32.84 2.44 2.05 2.84-.03.22-.05.44-.05.66 0 3.86 4.5 7 10 7s10-3.14 10-7c0-.22-.02-.44-.05-.66 1.2-.4 2.05-1.54 2.05-2.84zM2.3 13.37C1.5 13.07 1 12.35 1 11.5c0-1.1.9-2 2-2 .64 0 1.22.32 1.6.82-1.1.85-1.92 1.9-2.3 3.05zm3.7.13c0-1.1.9-2 2-2s2 .9 2 2-.9 2-2 2-2-.9-2-2zm9.8 4.8c-1.08.63-2.42.96-3.8.96-1.4 0-2.74-.34-3.8-.95-.24-.13-.32-.44-.2-.68.15-.24.46-.32.7-.18 1.83 1.06 4.76 1.06 6.6 0 .23-.13.53-.05.67.2.14.23.06.54-.18.67zm.2-2.8c-1.1 0-2-.9-2-2s.9-2 2-2 2 .9 2 2-.9 2-2 2zm5.7-2.13c-.38-1.16-1.2-2.2-2.3-3.05.38-.5.97-.82 1.6-.82 1.1 0 2 .9 2 2 0 .84-.53 1.57-1.3 1.87z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton WhatsApp -->
<a class="resp-sharing-button__link" href="whatsapp://send?text=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect%20https://vertx-howtos.github.io/web-and-oauth2-oidc" target="_blank" rel="noopener"
    aria-label="">
    <div class="resp-sharing-button resp-sharing-button--whatsapp resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M20.1 3.9C17.9 1.7 15 .5 12 .5 5.8.5.7 5.6.7 11.9c0 2 .5 3.9 1.5 5.6L.6 23.4l6-1.6c1.6.9 3.5 1.3 5.4 1.3 6.3 0 11.4-5.1 11.4-11.4-.1-2.8-1.2-5.7-3.3-7.8zM12 21.4c-1.7 0-3.3-.5-4.8-1.3l-.4-.2-3.5 1 1-3.4L4 17c-1-1.5-1.4-3.2-1.4-5.1 0-5.2 4.2-9.4 9.4-9.4 2.5 0 4.9 1 6.7 2.8 1.8 1.8 2.8 4.2 2.8 6.7-.1 5.2-4.3 9.4-9.5 9.4zm5.1-7.1c-.3-.1-1.7-.9-1.9-1-.3-.1-.5-.1-.7.1-.2.3-.8 1-.9 1.1-.2.2-.3.2-.6.1s-1.2-.5-2.3-1.4c-.9-.8-1.4-1.7-1.6-2-.2-.3 0-.5.1-.6s.3-.3.4-.5c.2-.1.3-.3.4-.5.1-.2 0-.4 0-.5C10 9 9.3 7.6 9 7c-.1-.4-.4-.3-.5-.3h-.6s-.4.1-.7.3c-.3.3-1 1-1 2.4s1 2.8 1.1 3c.1.2 2 3.1 4.9 4.3.7.3 1.2.5 1.6.6.7.2 1.3.2 1.8.1.6-.1 1.7-.7 1.9-1.3.2-.7.2-1.2.2-1.3-.1-.3-.3-.4-.6-.5z" />
                </svg>
        </div>
    </div>
</a>

<!-- Sharingbutton Telegram -->
<a class="resp-sharing-button__link" href="https://telegram.me/share/url?text=Securing%20a%20Web%20Application%20with%20OAuth2/OpenId%20Connect&amp;url=https://vertx-howtos.github.io/web-and-oauth2-oidc"
    target="_blank" rel="noopener" aria-label="">
    <div class="resp-sharing-button resp-sharing-button--telegram resp-sharing-button--small">
        <div aria-hidden="true" class="resp-sharing-button__icon resp-sharing-button__icon--solid">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
                <path
                    d="M.707 8.475C.275 8.64 0 9.508 0 9.508s.284.867.718 1.03l5.09 1.897 1.986 6.38a1.102 1.102 0 0 0 1.75.527l2.96-2.41a.405.405 0 0 1 .494-.013l5.34 3.87a1.1 1.1 0 0 0 1.046.135 1.1 1.1 0 0 0 .682-.803l3.91-18.795A1.102 1.102 0 0 0 22.5.075L.706 8.475z" />
                </svg>
        </div>
    </div>
</a>
    </div>
  </div>

  <div class="row">
    <div class="col">
      <hr>
      <p><small>Last published: 2021-06-25 00:28:29 +0000.</small></p>
    </div>
  </div>
</div>

<script>
  (function () {
    const blocks = document.getElementsByClassName("collapsed");
    for (let i = 0; i < blocks.length; i++) {
      const block = blocks[i];
      const blockWrapper = document.createElement("div");
      const details = document.createElement("details");
      const summary = document.createElement("summary");
      summary.innerHTML = "Details <em>(click to expand)</em>";
      details.appendChild(summary);
      details.appendChild(blockWrapper);
      block.parentNode.insertBefore(details, block);
      blockWrapper.appendChild(block);
    }
  })();
</script>

<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.6/umd/popper.min.js" integrity="sha384-wHAiFfRlMFy6i5SRaxvfOCifBUQy1xHdJ/yoi7FRNXMRBu5WHdZYu1hA6ZOblgut"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" integrity="sha384-B0UglyR+jN6CkvvICOB2joaf5I4l3gm9GU6Hc1og6Ls7i6U/mkkaduKaBhlAXv9k"
    crossorigin="anonymous"></script>
</body>

</html>